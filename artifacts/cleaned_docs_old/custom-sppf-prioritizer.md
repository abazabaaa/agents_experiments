---
title: Custom SPPF Prioritizer (Lark)
description: Demonstrates subclassing ForestVisitor to implement a custom SPPF node prioritizer for TreeForestTransformer in Lark, preferring parses with fewer token descendants.
source_url: https://lark-parser.readthedocs.io/en/stable/examples/advanced/prioritizer.html
edit_url: https://github.com/lark-parser/lark/blob/acfe33d943a1310f3ca26145eb2896bc5c4955c9/docs/examples/advanced/prioritizer.rst
related:
  - https://lark-parser.readthedocs.io/en/stable/examples/index.html
  - https://lark-parser.readthedocs.io/en/stable/examples/advanced/index.html
  - https://lark-parser.readthedocs.io/en/stable/examples/advanced/_json_parser.html
  - https://lark-parser.readthedocs.io/en/stable/examples/advanced/py3to2.html
---

# Custom SPPF Prioritizer

This example demonstrates how to subclass `ForestVisitor` to make a custom Shared Packed Parse Forest (SPPF) node prioritizer to be used with `TreeForestTransformer`.

The prioritizer below counts the number of token descendants for each node. By assigning tokens a cost of -1 and summing children, nodes with fewer token descendants receive a higher priority (less negative), favoring the more specific parse.

```python
from lark import Lark
from lark.parsers.earley_forest import ForestVisitor, TreeForestTransformer

class TokenPrioritizer(ForestVisitor):

    def visit_symbol_node_in(self, node):
        # visit the entire forest by returning node.children
        return node.children

    def visit_packed_node_in(self, node):
        return node.children

    def visit_symbol_node_out(self, node):
        priority = 0
        for child in node.children:
            # Tokens do not have a priority attribute
            # count them as -1
            priority += getattr(child, 'priority', -1)
        node.priority = priority

    def visit_packed_node_out(self, node):
        priority = 0
        for child in node.children:
            priority += getattr(child, 'priority', -1)
        node.priority = priority

    def on_cycle(self, node, path):
        raise Exception("Oops, we encountered a cycle.")

grammar = """
start: hello " " world | hello_world
hello: "Hello"
world: "World"
hello_world: "Hello World"
"""

parser = Lark(grammar, parser='earley', ambiguity='forest')
forest = parser.parse("Hello World")

print("Default prioritizer:")
tree = TreeForestTransformer(resolve_ambiguity=True).transform(forest)
print(tree.pretty())

forest = parser.parse("Hello World")

print("Custom prioritizer:")
tree = TreeForestTransformer(resolve_ambiguity=True, prioritizer=TokenPrioritizer()).transform(forest)
print(tree.pretty())

# Output:
#
# Default prioritizer:
# start
#   hello Hello
#
#   world World
#
# Custom prioritizer:
# start
#   hello_world   Hello World
```

Downloads:
- Python source: https://lark-parser.readthedocs.io/en/stable/_downloads/3c07a7adfbea6387847af2b079a58ed6/prioritizer.py
- Jupyter notebook: https://lark-parser.readthedocs.io/en/stable/_downloads/6dea8dbfb244508aaa3b8283470f8c2d/prioritizer.ipynb

Additional resources:
- Gallery generated by Sphinx-Gallery: https://sphinx-gallery.github.io/
- Latest version of this page: https://lark-parser.readthedocs.io/en/latest/examples/advanced/prioritizer.html
