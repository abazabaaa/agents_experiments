https://lark-parser.readthedocs.io/en/stable/_downloads/6dea8dbfb244508aaa3b8283470f8c2d/prioritizer.ipynb

```
{
  "cells": [\
    {\
      "cell_type": "markdown",\
      "metadata": {},\
      "source": [\
        "\n# Custom SPPF Prioritizer\n\nThis example demonstrates how to subclass ``ForestVisitor`` to make a custom\nSPPF node prioritizer to be used in conjunction with ``TreeForestTransformer``.\n\nOur prioritizer will count the number of descendants of a node that are tokens.\nBy negating this count, our prioritizer will prefer nodes with fewer token\ndescendants. Thus, we choose the more specific parse.\n"\
      ]\
    },\
    {\
      "cell_type": "code",\
      "execution_count": null,\
      "metadata": {\
        "collapsed": false\
      },\
      "outputs": [],\
      "source": [\
        "from lark import Lark\nfrom lark.parsers.earley_forest import ForestVisitor, TreeForestTransformer\n\nclass TokenPrioritizer(ForestVisitor):\n\n    def visit_symbol_node_in(self, node):\n        # visit the entire forest by returning node.children\n        return node.children\n\n    def visit_packed_node_in(self, node):\n        return node.children\n\n    def visit_symbol_node_out(self, node):\n        priority = 0\n        for child in node.children:\n            # Tokens do not have a priority attribute\n            # count them as -1\n            priority += getattr(child, 'priority', -1)\n        node.priority = priority\n\n    def visit_packed_node_out(self, node):\n        priority = 0\n        for child in node.children:\n            priority += getattr(child, 'priority', -1)\n        node.priority = priority\n\n    def on_cycle(self, node, path):\n        raise Exception(\"Oops, we encountered a cycle.\")\n\ngrammar = \"\"\"\nstart: hello \" \" world | hello_world\nhello: \"Hello\"\nworld: \"World\"\nhello_world: \"Hello World\"\n\"\"\"\n\nparser = Lark(grammar, parser='earley', ambiguity='forest')\nforest = parser.parse(\"Hello World\")\n\nprint(\"Default prioritizer:\")\ntree = TreeForestTransformer(resolve_ambiguity=True).transform(forest)\nprint(tree.pretty())\n\nforest = parser.parse(\"Hello World\")\n\nprint(\"Custom prioritizer:\")\ntree = TreeForestTransformer(resolve_ambiguity=True, prioritizer=TokenPrioritizer()).transform(forest)\nprint(tree.pretty())\n\n# Output:\n#\n# Default prioritizer:\n# start\n#   hello Hello\n#\n#   world World\n#\n# Custom prioritizer:\n# start\n#   hello_world   Hello World"\
      ]\
    }\
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.7.17"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 0
}
```