https://lark-parser.readthedocs.io/en/stable/examples/advanced/prioritizer.html

- [Home](https://lark-parser.readthedocs.io/en/stable/index.html)
- [Examples for Lark](https://lark-parser.readthedocs.io/en/stable/examples/index.html)
- [Advanced Examples](https://lark-parser.readthedocs.io/en/stable/examples/advanced/index.html)
- Custom SPPF Prioritizer
- [Edit on GitHub](https://github.com/lark-parser/lark/blob/acfe33d943a1310f3ca26145eb2896bc5c4955c9/docs/examples/advanced/prioritizer.rst)

[Previous](https://lark-parser.readthedocs.io/en/stable/examples/advanced/_json_parser.html "Simple JSON Parser") [Next](https://lark-parser.readthedocs.io/en/stable/examples/advanced/py3to2.html "Python 3 to Python 2 converter (tree templates)")

* * *

Note

[Go to the end](https://lark-parser.readthedocs.io/en/stable/examples/advanced/prioritizer.html#sphx-glr-download-examples-advanced-prioritizer-py)
to download the full example code

# Custom SPPF Prioritizer [](https://lark-parser.readthedocs.io/en/stable/examples/advanced/prioritizer.html\#custom-sppf-prioritizer "Permalink to this heading")

This example demonstrates how to subclass `ForestVisitor` to make a custom
SPPF node prioritizer to be used in conjunction with `TreeForestTransformer`.

Our prioritizer will count the number of descendants of a node that are tokens.
By negating this count, our prioritizer will prefer nodes with fewer token
descendants. Thus, we choose the more specific parse.

```
from lark import Lark
from lark.parsers.earley_forest import ForestVisitor, TreeForestTransformer

class TokenPrioritizer(ForestVisitor):

    def visit_symbol_node_in(self, node):
        # visit the entire forest by returning node.children
        return node.children

    def visit_packed_node_in(self, node):
        return node.children

    def visit_symbol_node_out(self, node):
        priority = 0
        for child in node.children:
            # Tokens do not have a priority attribute
            # count them as -1
            priority += getattr(child, 'priority', -1)
        node.priority = priority

    def visit_packed_node_out(self, node):
        priority = 0
        for child in node.children:
            priority += getattr(child, 'priority', -1)
        node.priority = priority

    def on_cycle(self, node, path):
        raise Exception("Oops, we encountered a cycle.")

grammar = """
start: hello " " world | hello_world
hello: "Hello"
world: "World"
hello_world: "Hello World"
"""

parser = Lark(grammar, parser='earley', ambiguity='forest')
forest = parser.parse("Hello World")

print("Default prioritizer:")
tree = TreeForestTransformer(resolve_ambiguity=True).transform(forest)
print(tree.pretty())

forest = parser.parse("Hello World")

print("Custom prioritizer:")
tree = TreeForestTransformer(resolve_ambiguity=True, prioritizer=TokenPrioritizer()).transform(forest)
print(tree.pretty())

# Output:
#
# Default prioritizer:
# start
#   hello Hello
#
#   world World
#
# Custom prioritizer:
# start
#   hello_world   Hello World

```

**Total running time of the script:** (0 minutes 0.000 seconds)

[`Download Python source code: prioritizer.py`](https://lark-parser.readthedocs.io/en/stable/_downloads/3c07a7adfbea6387847af2b079a58ed6/prioritizer.py)

[`Download Jupyter notebook: prioritizer.ipynb`](https://lark-parser.readthedocs.io/en/stable/_downloads/6dea8dbfb244508aaa3b8283470f8c2d/prioritizer.ipynb)

[Gallery generated by Sphinx-Gallery](https://sphinx-gallery.github.io/)

Versions[latest](https://lark-parser.readthedocs.io/en/latest/examples/advanced/prioritizer.html)**[stable](https://lark-parser.readthedocs.io/en/stable/examples/advanced/prioritizer.html)**Downloads[PDF](https://lark-parser.readthedocs.io/_/downloads/en/stable/pdf/)[HTML](https://lark-parser.readthedocs.io/_/downloads/en/stable/htmlzip/)[EPUB](https://lark-parser.readthedocs.io/_/downloads/en/stable/epub/)On Read the Docs[Project Home](https://app.readthedocs.org/projects/lark-parser/?utm_source=lark-parser&utm_content=flyout)[Builds](https://app.readthedocs.org/projects/lark-parser/builds/?utm_source=lark-parser&utm_content=flyout)Search

* * *

[Addons documentation](https://docs.readthedocs.io/page/addons.html?utm_source=lark-parser&utm_content=flyout) ― Hosted by
[Read the Docs](https://about.readthedocs.com/?utm_source=lark-parser&utm_content=flyout)