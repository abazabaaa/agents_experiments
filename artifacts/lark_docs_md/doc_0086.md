https://lark-parser.readthedocs.io/en/stable/_downloads/57b38708c982e98764460c3e288a1ff5/reconstruct_python.ipynb

```
{
  "cells": [\
    {\
      "cell_type": "markdown",\
      "metadata": {},\
      "source": [\
        "\n# Reconstruct Python\n\nDemonstrates how Lark's experimental text-reconstruction feature can recreate\nfunctional Python code from its parse-tree, using just the correct grammar and\na small formatter.\n"\
      ]\
    },\
    {\
      "cell_type": "code",\
      "execution_count": null,\
      "metadata": {\
        "collapsed": false\
      },\
      "outputs": [],\
      "source": [\
        "from lark import Token, Lark\nfrom lark.reconstruct import Reconstructor\nfrom lark.indenter import PythonIndenter\n\n# Official Python grammar by Lark\npython_parser3 = Lark.open_from_package('lark', 'python.lark', ['grammars'],\n                                        parser='lalr', postlex=PythonIndenter(), start='file_input',\n                                        maybe_placeholders=False    # Necessary for reconstructor\n                                        )\n\nSPACE_AFTER = set(',+-*/~@<>=\"|:')\nSPACE_BEFORE = (SPACE_AFTER - set(',:')) | set('\\'')\n\n\ndef special(sym):\n    return Token('SPECIAL', sym.name)\n\ndef postproc(items):\n    stack = ['\\n']\n    actions = []\n    last_was_whitespace = True\n    for item in items:\n        if isinstance(item, Token) and item.type == 'SPECIAL':\n            actions.append(item.value)\n        else:\n            if actions:\n                assert actions[0] == '_NEWLINE' and '_NEWLINE' not in actions[1:], actions\n\n                for a in actions[1:]:\n                    if a == '_INDENT':\n                        stack.append(stack[-1] + ' ' * 4)\n                    else:\n                        assert a == '_DEDENT'\n                        stack.pop()\n                actions.clear()\n                yield stack[-1]\n                last_was_whitespace = True\n            if not last_was_whitespace:\n                if item[0] in SPACE_BEFORE:\n                    yield ' '\n            yield item\n            last_was_whitespace = item[-1].isspace()\n            if not last_was_whitespace:\n                if item[-1] in SPACE_AFTER:\n                    yield ' '\n                    last_was_whitespace = True\n    yield \"\\n\"\n\n\nclass PythonReconstructor:\n    def __init__(self, parser):\n        self._recons = Reconstructor(parser, {'_NEWLINE': special, '_DEDENT': special, '_INDENT': special})\n\n    def reconstruct(self, tree):\n        return self._recons.reconstruct(tree, postproc)\n\n\ndef test():\n    python_reconstructor = PythonReconstructor(python_parser3)\n\n    self_contents = open(__file__).read()\n\n    tree = python_parser3.parse(self_contents+'\\n')\n    output = python_reconstructor.reconstruct(tree)\n\n    tree_new = python_parser3.parse(output)\n    print(tree.pretty())\n    print(tree_new.pretty())\n    # assert tree.pretty() == tree_new.pretty()\n    assert tree == tree_new\n\n    print(output)\n\n\nif __name__ == '__main__':\n    test()"\
      ]\
    }\
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.7.17"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 0
}
```