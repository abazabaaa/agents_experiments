https://lark-parser.readthedocs.io/en/stable/forest.html

- [Home](https://lark-parser.readthedocs.io/en/stable/index.html)
- Working with the SPPF
- [Edit on GitHub](https://github.com/lark-parser/lark/blob/acfe33d943a1310f3ca26145eb2896bc5c4955c9/docs/forest.rst)

[Previous](https://lark-parser.readthedocs.io/en/stable/visitors.html "Transformers & Visitors") [Next](https://lark-parser.readthedocs.io/en/stable/tools.html "Tools (Stand-alone, Nearley)")

* * *

# Working with the SPPF [](https://lark-parser.readthedocs.io/en/stable/forest.html\#working-with-the-sppf "Permalink to this heading")

When parsing with Earley, Lark provides the `ambiguity='forest'` option
to obtain the shared packed parse forest (SPPF) produced by the parser as
an alternative to it being automatically converted to a tree.

Lark provides a few tools to facilitate working with the SPPF. Here are some
things to consider when deciding whether or not to use the SPPF.

**Pros**

- Efficient storage of highly ambiguous parses

- Precise handling of ambiguities

- Custom rule prioritizers

- Ability to handle infinite ambiguities

- Directly transform forest -> object instead of forest -> tree -> object


**Cons**

- More complex than working with a tree

- SPPF may contain nodes corresponding to rules generated internally

- Loss of Lark grammar features:

  - Rules starting with ‘\_’ are not inlined in the SPPF

  - Rules starting with ‘?’ are never inlined in the SPPF

  - All tokens will appear in the SPPF

## SymbolNode [](https://lark-parser.readthedocs.io/en/stable/forest.html\#symbolnode "Permalink to this heading")

_class_ lark.parsers.earley\_forest.SymbolNode( _s_, _start_, _end_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.SymbolNode "Permalink to this definition")

A Symbol Node represents a symbol (or Intermediate LR0).

Symbol nodes are keyed by the symbol (s). For intermediate nodes
s will be an LR0, stored as a tuple of (rule, ptr). For completed symbol
nodes, s will be a string representing the non-terminal origin (i.e.
the left hand side of the rule).

The children of a Symbol or Intermediate Node will always be Packed Nodes;
with each Packed Node child representing a single derivation of a production.

Hence a Symbol Node with a single child is unambiguous.

Parameters:

- **s** – A Symbol, or a tuple of (rule, ptr) for an intermediate node.

- **start** – For dynamic lexers, the index of the start of the substring matched by this symbol (inclusive).

- **end** – For dynamic lexers, the index of the end of the substring matched by this symbol (exclusive).


Properties:

is\_intermediate: True if this node is an intermediate node.
priority: The priority of the node’s symbol.

_property_ is\_ambiguous [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.SymbolNode.is_ambiguous "Permalink to this definition")

Returns True if this node is ambiguous.

_property_ children [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.SymbolNode.children "Permalink to this definition")

Returns a list of this node’s children sorted from greatest to
least priority.

## PackedNode [](https://lark-parser.readthedocs.io/en/stable/forest.html\#packednode "Permalink to this heading")

_class_ lark.parsers.earley\_forest.PackedNode( _parent_, _s_, _rule_, _start_, _left_, _right_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.PackedNode "Permalink to this definition")

A Packed Node represents a single derivation in a symbol node.

Parameters:

- **rule** – The rule associated with this node.

- **parent** – The parent of this node.

- **left** – The left child of this node. `None` if one does not exist.

- **right** – The right child of this node. `None` if one does not exist.

- **priority** – The priority of this node.


_property_ children [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.PackedNode.children "Permalink to this definition")

Returns a list of this node’s children.

## ForestVisitor [](https://lark-parser.readthedocs.io/en/stable/forest.html\#forestvisitor "Permalink to this heading")

_class_ lark.parsers.earley\_forest.ForestVisitor( _single\_visit=False_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor "Permalink to this definition")

An abstract base class for building forest visitors.

This class performs a controllable depth-first walk of an SPPF.
The visitor will not enter cycles and will backtrack if one is encountered.
Subclasses are notified of cycles through the `on_cycle` method.

Behavior for visit events is defined by overriding the
`visit*node*` functions.

The walk is controlled by the return values of the `visit*node_in`
methods. Returning a node(s) will schedule them to be visited. The visitor
will begin to backtrack if no nodes are returned.

Parameters:

**single\_visit** – If `True`, non-Token nodes will only be visited once.

visit\_token\_node( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.visit_token_node "Permalink to this definition")

Called when a `Token` is visited. `Token` nodes are always leaves.

visit\_symbol\_node\_in( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.visit_symbol_node_in "Permalink to this definition")

Called when a symbol node is visited. Nodes that are returned
will be scheduled to be visited. If `visit_intermediate_node_in`
is not implemented, this function will be called for intermediate
nodes as well.

visit\_symbol\_node\_out( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.visit_symbol_node_out "Permalink to this definition")

Called after all nodes returned from a corresponding `visit_symbol_node_in`
call have been visited. If `visit_intermediate_node_out`
is not implemented, this function will be called for intermediate
nodes as well.

visit\_packed\_node\_in( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.visit_packed_node_in "Permalink to this definition")

Called when a packed node is visited. Nodes that are returned
will be scheduled to be visited.

visit\_packed\_node\_out( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.visit_packed_node_out "Permalink to this definition")

Called after all nodes returned from a corresponding `visit_packed_node_in`
call have been visited.

on\_cycle( _node_, _path_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.on_cycle "Permalink to this definition")

Called when a cycle is encountered.

Parameters:

- **node** – The node that causes a cycle.

- **path** – The list of nodes being visited: nodes that have been
entered but not exited. The first element is the root in a forest
visit, and the last element is the node visited most recently.
`path` should be treated as read-only.


get\_cycle\_in\_path( _node_, _path_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestVisitor.get_cycle_in_path "Permalink to this definition")

A utility function for use in `on_cycle` to obtain a slice of
`path` that only contains the nodes that make up the cycle.

## ForestTransformer [](https://lark-parser.readthedocs.io/en/stable/forest.html\#foresttransformer "Permalink to this heading")

_class_ lark.parsers.earley\_forest.ForestTransformer [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer "Permalink to this definition")

The base class for a bottom-up forest transformation. Most users will
want to use `TreeForestTransformer` instead as it has a friendlier
interface and covers most use cases.

Transformations are applied via inheritance and overriding of the
`transform*node` methods.

`transform_token_node` receives a `Token` as an argument.
All other methods receive the node that is being transformed and
a list of the results of the transformations of that node’s children.
The return value of these methods are the resulting transformations.

If `Discard` is raised in a node’s transformation, no data from that node
will be passed to its parent’s transformation.

transform( _root_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer.transform "Permalink to this definition")

Perform a transformation on an SPPF.

transform\_symbol\_node( _node_, _data_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer.transform_symbol_node "Permalink to this definition")

Transform a symbol node.

transform\_intermediate\_node( _node_, _data_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer.transform_intermediate_node "Permalink to this definition")

Transform an intermediate node.

transform\_packed\_node( _node_, _data_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer.transform_packed_node "Permalink to this definition")

Transform a packed node.

transform\_token\_node( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.ForestTransformer.transform_token_node "Permalink to this definition")

Transform a `Token`.

## TreeForestTransformer [](https://lark-parser.readthedocs.io/en/stable/forest.html\#treeforesttransformer "Permalink to this heading")

_class_ lark.parsers.earley\_forest.TreeForestTransformer( _tree\_class=<class'lark.tree.Tree'>_, _prioritizer=<lark.parsers.earley\_forest.ForestSumVisitorobject>_, _resolve\_ambiguity=True_, _use\_cache=False_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.TreeForestTransformer "Permalink to this definition")

A `ForestTransformer` with a tree `Transformer`-like interface.
By default, it will construct a tree.

Methods provided via inheritance are called based on the rule/symbol
names of nodes in the forest.

Methods that act on rules will receive a list of the results of the
transformations of the rule’s children. By default, trees and tokens.

Methods that act on tokens will receive a token.

Alternatively, methods that act on rules may be annotated with
`handles_ambiguity`. In this case, the function will receive a list
of all the transformations of all the derivations of the rule.
By default, a list of trees where each tree.data is equal to the
rule name or one of its aliases.

Non-tree transformations are made possible by override of
`__default__`, `__default_token__`, and `__default_ambig__`.

Note

Tree shaping features such as inlined rules and token filtering are
not built into the transformation. Positions are also not propagated.

Parameters:

- **tree\_class** – The tree class to use for construction

- **prioritizer** – A `ForestVisitor` that manipulates the priorities of nodes in the SPPF.

- **resolve\_ambiguity** – If True, ambiguities will be resolved based on priorities.

- **use\_cache** ( _bool_) – If True, caches the results of some transformations,
potentially improving performance when `resolve_ambiguity==False`.
Only use if you know what you are doing: i.e. All transformation
functions are pure and referentially transparent.


\_\_default\_\_( _name_, _data_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.TreeForestTransformer.__default__ "Permalink to this definition")

Default operation on tree (for override).

Returns a tree with name with data as children.

\_\_default\_ambig\_\_( _name_, _data_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.TreeForestTransformer.__default_ambig__ "Permalink to this definition")

Default operation on ambiguous rule (for override).

Wraps data in an ‘\_ambig\_’ node if it contains more than
one element.

\_\_default\_token\_\_( _node_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.TreeForestTransformer.__default_token__ "Permalink to this definition")

Default operation on `Token` (for override).

Returns `node`.

## handles\_ambiguity [](https://lark-parser.readthedocs.io/en/stable/forest.html\#handles-ambiguity "Permalink to this heading")

lark.parsers.earley\_forest.handles\_ambiguity( _func_) [](https://lark-parser.readthedocs.io/en/stable/forest.html#lark.parsers.earley_forest.handles_ambiguity "Permalink to this definition")

Decorator for methods of subclasses of `TreeForestTransformer`.
Denotes that the method should receive a list of transformed derivations.

Versions[latest](https://lark-parser.readthedocs.io/en/latest/forest.html)**[stable](https://lark-parser.readthedocs.io/en/stable/forest.html)**Downloads[PDF](https://lark-parser.readthedocs.io/_/downloads/en/stable/pdf/)[HTML](https://lark-parser.readthedocs.io/_/downloads/en/stable/htmlzip/)[EPUB](https://lark-parser.readthedocs.io/_/downloads/en/stable/epub/)On Read the Docs[Project Home](https://app.readthedocs.org/projects/lark-parser/?utm_source=lark-parser&utm_content=flyout)[Builds](https://app.readthedocs.org/projects/lark-parser/builds/?utm_source=lark-parser&utm_content=flyout)Search

* * *

[Addons documentation](https://docs.readthedocs.io/page/addons.html?utm_source=lark-parser&utm_content=flyout) ― Hosted by
[Read the Docs](https://about.readthedocs.com/?utm_source=lark-parser&utm_content=flyout)